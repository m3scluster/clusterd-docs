<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CMake for details about using the new CMake build system. - Apache Mesos</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Fundamentals</li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">1.</strong> Mesos Architecture providing an overview of Mesos concepts</a></li><li class="chapter-item expanded "><a href="presentations.html"><strong aria-hidden="true">2.</strong> Video and Slides of Mesos Presentations</a></li><li class="chapter-item expanded "><a href="versioning.html"><strong aria-hidden="true">3.</strong> Mesos Release and Support Policy</a></li><li class="chapter-item expanded affix "><li class="part-title">Build / Installation</li><li class="chapter-item expanded "><a href="building.html"><strong aria-hidden="true">4.</strong> Building for basic instructions on compiling and installing Mesos.</a></li><li class="chapter-item expanded "><a href="binary-packages.html"><strong aria-hidden="true">5.</strong> Binary Packages for how to use Mesos binary packages.</a></li><li class="chapter-item expanded "><a href="configuration.html"><strong aria-hidden="true">6.</strong> Configuration for build configuration options.</a></li><li class="chapter-item expanded "><a href="cmake.html" class="active"><strong aria-hidden="true">7.</strong> CMake for details about using the new CMake build system.</a></li><li class="chapter-item expanded "><a href="windows.html"><strong aria-hidden="true">8.</strong> Windows Support for the state of Windows support in Mesos.</a></li><li class="chapter-item expanded affix "><li class="part-title">Administration</li><li class="chapter-item expanded "><a href="configuration.html"><strong aria-hidden="true">9.</strong> Configuration for command-line arguments.</a></li><li class="chapter-item expanded "><a href="high-availability.html"><strong aria-hidden="true">10.</strong> High Availability Master Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="replicated-log-internals.html"><strong aria-hidden="true">10.1.</strong> Replicated Log for information on the Mesos replicated log.</a></li></ol></li><li class="chapter-item expanded "><a href="agent-recovery.html"><strong aria-hidden="true">11.</strong> Fault Tolerant Agent Setup</a></li><li class="chapter-item expanded "><a href="framework-rate-limiting.html"><strong aria-hidden="true">12.</strong> Framework Rate Limiting</a></li><li class="chapter-item expanded "><a href="maintenance.html"><strong aria-hidden="true">13.</strong> Maintenance for performing maintenance on a Mesos cluster.</a></li><li class="chapter-item expanded "><a href="upgrades.html"><strong aria-hidden="true">14.</strong> Upgrades for upgrading a Mesos cluster.</a></li><li class="chapter-item expanded "><a href="downgrades.html"><strong aria-hidden="true">15.</strong> Downgrades for downgrading a Mesos cluster.</a></li><li class="chapter-item expanded "><a href="logging.html"><strong aria-hidden="true">16.</strong> Logging</a></li><li class="chapter-item expanded "><a href="monitoring.html"><strong aria-hidden="true">17.</strong> Monitoring / Metrics</a></li><li class="chapter-item expanded "><a href="cli.html"><strong aria-hidden="true">18.</strong> Debugging using the new CLI</a></li><li class="chapter-item expanded "><a href="operational-guide.html"><strong aria-hidden="true">19.</strong> Operational Guide</a></li><li class="chapter-item expanded "><a href="fetcher.html"><strong aria-hidden="true">20.</strong> Fetcher Cache Configuration</a></li><li class="chapter-item expanded "><a href="fault-domains.html"><strong aria-hidden="true">21.</strong> Fault Domains</a></li><li class="chapter-item expanded "><a href="performance-profiling.html"><strong aria-hidden="true">22.</strong> Performance Profiling for debugging performance issues in Mesos.</a></li><li class="chapter-item expanded "><a href="memory-profiling.html"><strong aria-hidden="true">23.</strong> Memory Profiling for debugging potential memory leaks in Mesos.</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Apache Mesos</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/AVENTER-UG/mesos-docs/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="install-cmake-37"><a class="header" href="#install-cmake-37">Install CMake 3.7+</a></h1>
<h2 id="linux"><a class="header" href="#linux">Linux</a></h2>
<p>Install the latest version of CMake from <a href="https://cmake.org/download/">CMake.org</a>.
A self-extracting tarball is available to make this process painless.</p>
<p>Currently, few of the common Linux flavors package a sufficient CMake
version. Ubuntu versions 12.04 and 14.04 package CMake 2;
Ubuntu 16.04 packages CMake 3.5. If you already installed cmake from packages,
you may remove it via: <code>apt-get purge cmake</code>.</p>
<p>The standard CentOS package is CMake 2, and unfortunately even the <code>cmake3</code>
package in EPEL is only CMake 3.6, you may remove them via:
<code>yum remove cmake cmake3</code>.</p>
<h2 id="mac-os-x"><a class="header" href="#mac-os-x">Mac OS X</a></h2>
<p>HomeBrew's CMake version is sufficient: <code>brew install cmake</code>.</p>
<h2 id="windows"><a class="header" href="#windows">Windows</a></h2>
<p>Download and install the MSI from <a href="https://cmake.org/download/">CMake.org</a>.</p>
<p><strong>NOTE:</strong> Windows needs CMake 3.8+, rather than 3.7+.</p>
<h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<p>The most basic way to build with CMake, with no configuration, is fairly
straightforward:</p>
<pre><code>mkdir build
cd build
cmake ..
cmake --build .
</code></pre>
<p>The last step, <code>cmake --build .</code> can also take a <code>--target</code> command to build any
particular target (e.g. <code>mesos-tests</code>, or <code>tests</code> to build <code>mesos-tests</code>,
<code>libprocess-tests</code>, and <code>stout-tests</code>): <code>cmake --build . --target tests</code>. To
send arbitrary flags to the native build system underneath (e.g. <code>make</code>), append
the command with <code>-- &lt;flags to be passed&gt;</code>: <code>cmake --build . -- -j4</code>.</p>
<p>Also, <code>cmake --build</code> can be substituted by your build system of choice. For
instance, the default CMake generator on Linux produces GNU Makefiles, so after
configuring with <code>cmake ..</code>, you can just run <code>make tests</code> in the <code>build</code> folder
like usual. Similarly, if you configure with <code>-G Ninja</code> to use the Ninja
generator, you can then run <code>ninja tests</code> to build the <code>tests</code> target with
Ninja.</p>
<h1 id="installable-build"><a class="header" href="#installable-build">Installable build</a></h1>
<p>This example will build Mesos and install it into a custom prefix:</p>
<pre><code>mkdir build &amp;&amp; cd build
cmake -DCMAKE_INSTALL_PREFIX=/home/current_user/mesos
cmake --build . --target install
</code></pre>
<p>To additionally install <code>mesos-tests</code> executable and related test helpers
(this can be used to run Mesos tests against the installed binaries),
one can enable the <code>MESOS_INSTALL_TESTS</code> option.</p>
<p>To produce a set of binaries and libraries that will work after being
copied/moved to a different location, use <code>MESOS_FINAL_PREFIX</code>.</p>
<p>The example below employs both <code>MESOS_FINAL_PREFIX</code> and <code>MESOS_INSTALL_TESTS</code>.
On a build system:</p>
<pre><code>mkdir build &amp;&amp; cd build
cmake -DMESOS_FINAL_PREFIX=/opt/mesos -DCMAKE_INSTALL_PREFIX=/home/current_user/mesos -DMESOS_INSTALL_TESTS=ON
cmake --build . --target install
tar -czf mesos.tar.gz mesos -C /home/current_user
</code></pre>
<p>On a target system:</p>
<pre><code>sudo tar -xf mesos.tar.gz -C /opt
# Run tests against Mesos installation
sudo /opt/mesos/bin/mesos-tests
# Start Mesos agent
sudo /opt/mesos/bin/mesos-agent --work-dir=/var/lib/mesos ...
</code></pre>
<h1 id="supported-options"><a class="header" href="#supported-options">Supported options</a></h1>
<p>See <a href="configuration/cmake.html">configuration options</a>.</p>
<h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>See <a href="cmake-examples.html">CMake By Example</a>.</p>
<h1 id="documentation"><a class="header" href="#documentation">Documentation</a></h1>
<p>The <a href="https://cmake.org/cmake/help/latest/">CMake documentation</a> is written as a reference module. The most commonly
used sections are:</p>
<ul>
<li><a href="https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html">buildsystem overview</a></li>
<li><a href="https://cmake.org/cmake/help/latest/manual/cmake-commands.7.html">commands</a></li>
<li><a href="https://cmake.org/cmake/help/latest/manual/cmake-properties.7.html">properties</a></li>
<li><a href="https://cmake.org/cmake/help/latest/manual/cmake-variables.7.html">variables</a></li>
</ul>
<p>The wiki also has a set of <a href="https://cmake.org/Wiki/CMake_Useful_Variables">useful variables</a>.</p>
<h1 id="dependency-graph"><a class="header" href="#dependency-graph">Dependency graph</a></h1>
<p>Like any build system, CMake has a dependency graph. The difference is
that targets in CMake's dependency graph are <em>much richer</em> compared to other
build systems. CMake targets have the notion of 'interfaces', where build
properties are saved as part of the target, and these properties can be
inherited transitively within the graph.</p>
<p>For example, say there is a library <code>mylib</code>, and anything which links it must
include its headers, located in <code>mylib/include</code>. When building the library, some
private headers must also be included, but not when linking to it. When
compiling the executable <code>myprogram</code>, <code>mylib</code>'s public headers must be included,
but not its private headers. There is no manual step to add <code>mylib/include</code> to
<code>myprogram</code> (and any other program which links to <code>mylib</code>), it is instead
deduced from the public interface property of <code>mylib</code>. This is represented by
the following code:</p>
<pre><code># A new library with a single source file (headers are found automatically).
add_library(mylib mylib.cpp)

# The folder of private headers, not exposed to consumers of `mylib`.
target_include_directories(mylib PRIVATE mylib/private)

# The folder of public headers, added to the compilation of any consumer.
target_include_directories(mylib PUBLIC mylib/include)

# A new exectuable with a single source file.
add_executable(myprogram main.cpp)

# The creation of the link dependency `myprogram` -&gt; `mylib`.
target_link_libraries(myprogram mylib)

# There is no additional step to add `mylib/include` to `myprogram`.
</code></pre>
<p>This same notion applies to practically every build property:
compile definitions via <a href="https://cmake.org/cmake/help/latest/command/target_compile_definitions.html"><code>target_compile_definitions</code></a>,
include directories via <a href="https://cmake.org/cmake/help/latest/command/target_include_directories.html"><code>target_include_directories</code></a>,
link libraries via <a href="https://cmake.org/cmake/help/latest/command/target_link_libraries.html"><code>target_link_libraries</code></a>,
compile options via <a href="https://cmake.org/cmake/help/latest/command/target_compile_options.html"><code>target_compile_options</code></a>,
and compile features via <a href="https://cmake.org/cmake/help/latest/command/target_compile_features.html"><code>target_compile_features</code></a>.</p>
<p>All of these commands also take an optional argument of
<code>&lt;INTERFACE|PUBLIC|PRIVATE&gt;</code>, which constrains their transitivity in the graph.
That is, a <code>PRIVATE</code> include directory is recorded for the target, but not
shared transitively to anything depending on the target, <code>PUBLIC</code> is used
for both the target and dependencies on it, and <code>INTERFACE</code> is used only
for dependencies.</p>
<p>Notably missing from this list are link directories. CMake explicitly prefers
finding and using the absolute paths to libraries, obsoleting link directories.</p>
<h1 id="common-mistakes"><a class="header" href="#common-mistakes">Common mistakes</a></h1>
<h2 id="booleans"><a class="header" href="#booleans">Booleans</a></h2>
<p>CMake treats <code>ON</code>, <code>OFF</code>, <code>TRUE</code>, <code>FALSE</code>, <code>1</code>, and <code>0</code> all as true/false
booleans. Furthermore, variables of the form <code>&lt;target&gt;-NOTFOUND</code> are also
treated as false (this is used for finding packages).</p>
<p>In Mesos, we prefer the boolean types <code>TRUE</code> and <code>FALSE</code>.</p>
<p>See <a href="https://cmake.org/cmake/help/latest/command/if.html"><code>if</code></a> for more info.</p>
<h2 id="conditionals"><a class="header" href="#conditionals">Conditionals</a></h2>
<p>For historical reasons, CMake conditionals such as <code>if</code> and <code>elseif</code>
automatically interpolate variable names. It is therefore dangerous to
interpolate them manually, because if <code>${FOO}</code> evaluates to <code>BAR</code>, and <code>BAR</code> is
another variable name, then <code>if (${FOO})</code> becomes <code>if (BAR)</code>, and <code>BAR</code> is then
evaluated again by the <code>if</code>. Stick to <code>if (FOO)</code> to check the value of <code>${FOO}</code>.
Do not use <code>if (${FOO})</code>.</p>
<p>Also see the CMake policies
<a href="https://cmake.org/cmake/help/latest/policy/CMP0012.html">CMP0012</a> and
<a href="https://cmake.org/cmake/help/latest/policy/CMP0054.html">CMP0054</a>.</p>
<h2 id="definitions"><a class="header" href="#definitions">Definitions</a></h2>
<p>When using <code>add_definitions()</code> (which should be used rarely, as it is for
&quot;global&quot; compile definitions), the flags must be prefixed with <code>-D</code> to be
treated as preprocessor definitions. However, when using
<code>target_compile_definitions()</code> (which should be preferred, as it is
for specific targets), the flags do not need the prefix.</p>
<h1 id="style"><a class="header" href="#style">Style</a></h1>
<p>In general, wrap at 80 lines, and use a two-space indent. When wrapping
arguments, put the command on a separate line and arguments on subsequent lines:</p>
<pre><code>target_link_libraries(
  program PRIVATE
  alpha
  beta
  gamma)
</code></pre>
<p>Otherwise keep it together:</p>
<pre><code>target_link_libraries(program PUBLIC library)
</code></pre>
<p>Always keep the trailing parenthesis with the last argument.</p>
<p>Use a single space between conditionals and their open parenthesis, e.g.
<code>if (FOO)</code>, but not for commands, e.g. <code>add_executable(program)</code>.</p>
<p>CAPITALIZE the declaration and use of custom functions and macros (e.g.
<code>EXTERNAL</code> and <code>PATCH_CMD</code>), and do not capitalize the use of CMake built-in
(including modules) functions and macros. CAPITALIZE variables.</p>
<h1 id="cmake-anti-patterns"><a class="header" href="#cmake-anti-patterns">CMake anti-patterns</a></h1>
<p>Because CMake handles much more of the grunt work for you than other build
systems, there are unfortunately a lot of CMake <a href="http://voices.canonical.com/jussi.pakkanen/2013/03/26/a-list-of-common-cmake-antipatterns/">anti-patterns</a> you should
look out for when writing new CMake code. These are some common problems
that should be avoided when writing new CMake code:</p>
<h2 id="superfluous-use-of-add_dependencies"><a class="header" href="#superfluous-use-of-add_dependencies">Superfluous use of <code>add_dependencies</code></a></h2>
<p>When you've linked library <code>a</code> to library <code>b</code> with <code>target_link_libraries(a b)</code>,
the CMake graph is already updated with the dependency information. It is
redundant to use <code>add_dependencies(a b)</code> to (re)specify the dependency. In fact,
this command should <em>rarely</em> be used.</p>
<p>The exceptions to this are:</p>
<ol>
<li>Setting a dependency from an imported library to a target added via
<code>ExternalProject_Add</code>.</li>
<li>Setting a dependency on Mesos modules since no explicit linking is done.</li>
<li>Setting a dependency between executables (e.g. the <code>mesos-agent</code> requiring the
<code>mesos-containerizer</code> executable). In general, runtime dependencies need
to be setup with <code>add_dependency</code>, but never link dependencies.</li>
</ol>
<h2 id="use-of-link_libraries-or-link_directories"><a class="header" href="#use-of-link_libraries-or-link_directories">Use of <code>link_libraries</code> or <code>link_directories</code></a></h2>
<p>Neither of these commands should ever be used. The only appropriate command used
to link libraries is <a href="https://cmake.org/cmake/help/latest/command/target_link_libraries.html"><code>target_link_libraries</code></a>, which records the information
in the CMake dependency graph. Furthermore, imported third-party libraries
should have correct locations recorded in their respective targets, so the use
of <code>link_directories</code> should never be necessary. The
<a href="https://cmake.org/cmake/help/latest/command/link_directories.html">official documentation</a> states:</p>
<blockquote>
<p>Note that this command is rarely necessary. Library locations returned by
<code>find_package()</code> and <code>find_library()</code> are absolute paths. Pass these absolute
library file paths directly to the <code>target_link_libraries()</code> command. CMake
will ensure the linker finds them.</p>
</blockquote>
<p>The difference is that the former sets global (or directory level) side effects,
and the latter sets specific target information stored in the graph.</p>
<h2 id="use-of-include_directories"><a class="header" href="#use-of-include_directories">Use of <code>include_directories</code></a></h2>
<p>This is similar to the above: the <a href="https://cmake.org/cmake/help/latest/command/target_include_directories.html"><code>target_include_directories</code></a> should always
be preferred so that the include directory information remains localized to the
appropriate targets.</p>
<h2 id="adding-anything-to-endif-"><a class="header" href="#adding-anything-to-endif-">Adding anything to <code>endif ()</code></a></h2>
<p>Old versions of CMake expected the style <code>if (FOO) ... endif (FOO)</code>, where the
<code>endif</code> contained the same expression as the <code>if</code> command. However, this is
tortuously redundant, so leave the parentheses in <code>endif ()</code> empty. This goes
for other endings too, such as <code>endforeach ()</code>, <code>endwhile ()</code>, <code>endmacro ()</code> and
<code>endfunction ()</code>.</p>
<h2 id="specifying-header-files-superfluously"><a class="header" href="#specifying-header-files-superfluously">Specifying header files superfluously</a></h2>
<p>One of the distinct advantages of using CMake for C and C++ projects is that
adding header files to the source list for a target is unnecessary. CMake is
designed to parse the source files (<code>.c</code>, <code>.cpp</code>, etc.) and determine their
required headers automatically. The exception to this is headers generated as
part of the build (such as protobuf or the JNI headers).</p>
<h2 id="checking-cmake_build_type"><a class="header" href="#checking-cmake_build_type">Checking <code>CMAKE_BUILD_TYPE</code></a></h2>
<p>See the <a href="cmake-examples.html#building-debug-or-release-configurations">&quot;Building debug or release configurations&quot;</a>
example for more information. In short, not all generators respect the variable
<code>CMAKE_BUILD_TYPE</code> at configuration time, and thus it must not be used in CMake
logic. A usable alternative (where supported) is a <a href="https://cmake.org/cmake/help/latest/manual/cmake-generator-expressions.7.html#logical-expressions">generator expression</a> such
as <code>$&lt;$&lt;CONFIG:Debug&gt;:DEBUG_MODE&gt;</code>.</p>
<h1 id="remaining-hacks"><a class="header" href="#remaining-hacks">Remaining hacks</a></h1>
<h2 id="3rdparty_dependencies"><a class="header" href="#3rdparty_dependencies"><code>3RDPARTY_DEPENDENCIES</code></a></h2>
<p>Until Mesos on Windows is stable, we keep some dependencies in an external
repository, <a href="https://github.com/mesos/3rdparty">3rdparty</a>. When
all dependencies are bundled with Mesos, this extra repository will no longer be
necessary. Until then, the CMake variable <code>3RDPARTY_DEPENDENCIES</code> points by
default to this URL, but it can also point to the on-disk location of a local
clone of the repo. With this option you can avoid pulling from GitHub for every
clean build. Note that this must be an absolute path with forward slashes, e.g.
<code>-D3RDPARTY_DEPENDENCIES=C:/3rdparty</code>, otherwise it will fail on Windows.</p>
<h2 id="external"><a class="header" href="#external"><code>EXTERNAL</code></a></h2>
<p>The CMake function <code>EXTERNAL</code> defines a few variables that make it easy for us
to track the directory structure of a dependency. In particular, if our
library's name is <code>boost</code>, we invoke:</p>
<pre><code>EXTERNAL(boost ${BOOST_VERSION} ${CMAKE_CURRENT_BINARY_DIR})
</code></pre>
<p>Which will define the following variables as side-effects in the current scope:</p>
<ul>
<li><code>BOOST_TARGET</code>     (a target folder name to put dep in e.g., <code>boost-1.53.0</code>)</li>
<li><code>BOOST_CMAKE_ROOT</code> (where to have CMake put the uncompressed source, e.g.,
<code>build/3rdparty/boost-1.53.0</code>)</li>
<li><code>BOOST_ROOT</code>       (where the code goes in various stages of build, e.g.,
<code>build/.../boost-1.53.0/src</code>, which might contain folders
<code>build-1.53.0-build</code>, <code>-lib</code>, and so on, for each build
step that dependency has)</li>
</ul>
<p>The implementation is in <code>3rdparty/cmake/External.cmake</code>.</p>
<p>This is not to be confused with the CMake module <a href="https://cmake.org/cmake/help/latest/module/ExternalProject.html">ExternalProject</a>, from which
we use <code>ExternalProject_Add</code> to download, extract, configure, and build our
dependencies.</p>
<h2 id="cmake_noop"><a class="header" href="#cmake_noop"><code>CMAKE_NOOP</code></a></h2>
<p>This is a CMake variable we define in <code>3rdparty/CMakeLists.txt</code> so that we can
cancel steps of <code>ExternalProject</code>. <code>ExternalProject</code>'s default behavior is to
attempt to configure, build, and install a project using CMake. So when one of
these steps must be skipped, we use set it to <code>CMAKE_NOOP</code> so that nothing
is run instead.</p>
<h2 id="cmake_forward_args"><a class="header" href="#cmake_forward_args"><code>CMAKE_FORWARD_ARGS</code></a></h2>
<p>The <code>CMAKE_FORWARD_ARGS</code> variable defined in <code>3rdparty/CMakeLists.txt</code> is sent
as the <code>CMAKE_ARGS</code> argument to the <code>ExternalProject_Add</code> macro (along with any
per-project arguments), and is used when the external project is configured as a
CMake project. If either the <code>CONFIGURE_COMMAND</code> or <code>BUILD_COMMAND</code> arguments of
<code>ExternalProject_Add</code> are used, then the <code>CMAKE_ARGS</code> argument will be ignored.
This variable ensures that compilation configurations are properly propagated to
third-party dependencies, such as compiler flags.</p>
<h3 id="cmake_ssl_forward_args"><a class="header" href="#cmake_ssl_forward_args"><code>CMAKE_SSL_FORWARD_ARGS</code></a></h3>
<p>The <code>CMAKE_SSL_FORWARD_ARGS</code> variable defined in <code>3rdparty/CMakeLists.txt</code>
is like <code>CMAKE_FORWARD_ARGS</code>, but only used for specific external projects
that find and link against OpenSSL.</p>
<h2 id="library_linkage"><a class="header" href="#library_linkage"><code>LIBRARY_LINKAGE</code></a></h2>
<p>This variable is a shortcut used in <code>3rdparty/CMakeLists.txt</code>. It is set to
<code>SHARED</code> when <code>BUILD_SHARED_LIBS</code> is true, and otherwise it is set to <code>STATIC</code>.
The <code>SHARED</code> and <code>STATIC</code> keywords are used to declare how a library should be
built; however, if left out then the type is deduced automatically from
<code>BUILD_SHARED_LIBS</code>.</p>
<h2 id="make_include_dir"><a class="header" href="#make_include_dir"><code>MAKE_INCLUDE_DIR</code></a></h2>
<p>This function works around a <a href="https://gitlab.kitware.com/cmake/cmake/issues/15052">CMake issue</a> with setting include
directories of imported libraries built with <code>ExternalProject_Add</code>. We have to
call this for each <code>IMPORTED</code> third-party dependency which has set
<code>INTERFACE_INCLUDE_DIRECTORIES</code>, just to make CMake happy. An example is Glog:</p>
<pre><code>MAKE_INCLUDE_DIR(glog)
</code></pre>
<h2 id="get_byproducts"><a class="header" href="#get_byproducts"><code>GET_BYPRODUCTS</code></a></h2>
<p>This function works around a <a href="https://cmake.org/pipermail/cmake/2015-April/060234.html">CMake issue</a> with the Ninja
generator where it does not understand imported libraries, and instead needs
<code>BUILD_BYPRODUCTS</code> explicitly set. This simply allows us to use
<code>ExternalProject_Add</code> and Ninja. For Glog, it looks like this:</p>
<pre><code>GET_BYPRODUCTS(glog)
</code></pre>
<p>Also see the CMake policy <a href="https://cmake.org/cmake/help/latest/policy/CMP0058.html">CMP0058</a>.</p>
<h2 id="patch_cmd"><a class="header" href="#patch_cmd"><code>PATCH_CMD</code></a></h2>
<p>The CMake function <code>PATCH_CMD</code> generates a patch command given a patch file.
If the path is not absolute, it's resolved to the current source directory.
It stores the command in the variable name supplied. This is used to easily
patch third-party dependencies. For Glog, it looks like this:</p>
<pre><code>PATCH_CMD(GLOG_PATCH_CMD glog-${GLOG_VERSION}.patch)
ExternalProject_Add(
  ${GLOG_TARGET}
  ...
  PATCH_COMMAND     ${GLOG_PATCH_CMD})
</code></pre>
<p>The implementation is in <code>3rdparty/cmake/PatchCommand.cmake</code>.</p>
<h3 id="windows-patchexe"><a class="header" href="#windows-patchexe">Windows <code>patch.exe</code></a></h3>
<p>While using <code>patch</code> on Linux is straightforward, doing the same on Windows takes
a bit of work. <code>PATH_CMD</code> encapsulates this:</p>
<ul>
<li>Checks the cache variable <code>PATCHEXE_PATH</code> for <code>patch.exe</code>.</li>
<li>Searches for <code>patch.exe</code> in its default locations.</li>
<li>Copies <code>patch.exe</code> and a custom manifest to the temporary directory.</li>
<li>Applies the manifest to avoid the UAC prompt.</li>
<li>Uses the patched <code>patch.exe</code>.</li>
</ul>
<p>As such, <code>PATCH_CMD</code> lets us apply patches as we do on Linux, without requiring
an administrative prompt.</p>
<p>Note that on Windows, the patch file must have CRLF line endings. A file with LF
line endings will cause the error: &quot;Assertion failed, hunk, file patch.c, line
343&quot;. For this reason, it is required to checkout the Mesos repo with <code>git config core.autocrlf true</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="configuration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="windows.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="configuration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="windows.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
