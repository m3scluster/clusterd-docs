<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Container Images for supporting container images in Mesos containerizer. - Apache Mesos</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Fundamentals</li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">1.</strong> Mesos Architecture providing an overview of Mesos concepts</a></li><li class="chapter-item expanded "><a href="presentations.html"><strong aria-hidden="true">2.</strong> Video and Slides of Mesos Presentations</a></li><li class="chapter-item expanded "><a href="versioning.html"><strong aria-hidden="true">3.</strong> Mesos Release and Support Policy</a></li><li class="chapter-item expanded affix "><li class="part-title">Build / Installation</li><li class="chapter-item expanded "><a href="building.html"><strong aria-hidden="true">4.</strong> Building for basic instructions on compiling and installing Mesos.</a></li><li class="chapter-item expanded "><a href="binary-packages.html"><strong aria-hidden="true">5.</strong> Binary Packages for how to use Mesos binary packages.</a></li><li class="chapter-item expanded "><a href="configuration.html"><strong aria-hidden="true">6.</strong> Configuration for build configuration options.</a></li><li class="chapter-item expanded "><a href="cmake.html"><strong aria-hidden="true">7.</strong> CMake for details about using the new CMake build system.</a></li><li class="chapter-item expanded "><a href="windows.html"><strong aria-hidden="true">8.</strong> Windows Support for the state of Windows support in Mesos.</a></li><li class="chapter-item expanded affix "><li class="part-title">Administration</li><li class="chapter-item expanded "><a href="configuration.html"><strong aria-hidden="true">9.</strong> Configuration for command-line arguments.</a></li><li class="chapter-item expanded "><a href="high-availability.html"><strong aria-hidden="true">10.</strong> High Availability Master Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="replicated-log-internals.html"><strong aria-hidden="true">10.1.</strong> Replicated Log for information on the Mesos replicated log.</a></li></ol></li><li class="chapter-item expanded "><a href="agent-recovery.html"><strong aria-hidden="true">11.</strong> Fault Tolerant Agent Setup</a></li><li class="chapter-item expanded "><a href="framework-rate-limiting.html"><strong aria-hidden="true">12.</strong> Framework Rate Limiting</a></li><li class="chapter-item expanded "><a href="maintenance.html"><strong aria-hidden="true">13.</strong> Maintenance for performing maintenance on a Mesos cluster.</a></li><li class="chapter-item expanded "><a href="upgrades.html"><strong aria-hidden="true">14.</strong> Upgrades for upgrading a Mesos cluster.</a></li><li class="chapter-item expanded "><a href="downgrades.html"><strong aria-hidden="true">15.</strong> Downgrades for downgrading a Mesos cluster.</a></li><li class="chapter-item expanded "><a href="logging.html"><strong aria-hidden="true">16.</strong> Logging</a></li><li class="chapter-item expanded "><a href="monitoring.html"><strong aria-hidden="true">17.</strong> Monitoring / Metrics</a></li><li class="chapter-item expanded "><a href="cli.html"><strong aria-hidden="true">18.</strong> Debugging using the new CLI</a></li><li class="chapter-item expanded "><a href="operational-guide.html"><strong aria-hidden="true">19.</strong> Operational Guide</a></li><li class="chapter-item expanded "><a href="fetcher.html"><strong aria-hidden="true">20.</strong> Fetcher Cache Configuration</a></li><li class="chapter-item expanded "><a href="fault-domains.html"><strong aria-hidden="true">21.</strong> Fault Domains</a></li><li class="chapter-item expanded "><a href="performance-profiling.html"><strong aria-hidden="true">22.</strong> Performance Profiling for debugging performance issues in Mesos.</a></li><li class="chapter-item expanded "><a href="memory-profiling.html"><strong aria-hidden="true">23.</strong> Memory Profiling for debugging potential memory leaks in Mesos.</a></li><li class="chapter-item expanded affix "><li class="part-title">Resource Management</li><li class="chapter-item expanded "><a href="attributes-resources.html"><strong aria-hidden="true">24.</strong> Attributes and Resources for how to describe the agents that comprise a cluster.</a></li><li class="chapter-item expanded "><a href="roles.html"><strong aria-hidden="true">25.</strong> Using Resource Roles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="weights.html"><strong aria-hidden="true">25.1.</strong> Resource Role Weights for fair sharing.</a></li><li class="chapter-item expanded "><a href="quota.html"><strong aria-hidden="true">25.2.</strong> Resource Role Quota for how to configure Mesos to provide guaranteed resource allocations for use by a role.</a></li><li class="chapter-item expanded "><a href="reservation.html"><strong aria-hidden="true">25.3.</strong> Reservations for how operators and frameworks can reserve resources on individual agents for use by a role.</a></li><li class="chapter-item expanded "><a href="shared-resources.html"><strong aria-hidden="true">25.4.</strong> Shared Resources for how to share persistent volumes between tasks managed by different executors on the same agent.</a></li></ol></li><li class="chapter-item expanded "><a href="oversubscription.html"><strong aria-hidden="true">26.</strong> Oversubscription for how to configure Mesos to take advantage of unused resources to launch “best-effort” tasks.</a></li><li class="chapter-item expanded affix "><li class="part-title">Security</li><li class="chapter-item expanded "><a href="authentication.html"><strong aria-hidden="true">27.</strong> Authentication</a></li><li class="chapter-item expanded "><a href="authorization.html"><strong aria-hidden="true">28.</strong> Authorization</a></li><li class="chapter-item expanded "><a href="ssl.html"><strong aria-hidden="true">29.</strong> SSL</a></li><li class="chapter-item expanded "><a href="secrets.html"><strong aria-hidden="true">30.</strong> Secrets for managing secrets within Mesos.</a></li><li class="chapter-item expanded affix "><li class="part-title">Containerization</li><li class="chapter-item expanded "><a href="containerizers.html"><strong aria-hidden="true">31.</strong> Containerizer Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="containerizer-internals.html"><strong aria-hidden="true">31.1.</strong> Containerizer Internals for implementation details of containerizers.</a></li><li class="chapter-item expanded "><a href="docker-containerizer.html"><strong aria-hidden="true">31.2.</strong> Docker Containerizer for launching a Docker image as a Task, or as an Executor.</a></li><li class="chapter-item expanded "><a href="mesos-containerizer.html"><strong aria-hidden="true">31.3.</strong> Mesos Containerizer default containerizer, supports both Linux and POSIX systems.</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="container-image.html" class="active"><strong aria-hidden="true">31.3.1.</strong> Container Images for supporting container images in Mesos containerizer.</a></li><li class="chapter-item expanded "><a href="isolators/docker-volume.html"><strong aria-hidden="true">31.3.2.</strong> Docker Volume Support</a></li><li class="chapter-item expanded "><a href="gpu-support.html"><strong aria-hidden="true">31.3.3.</strong> Nvidia GPU Support for how to run Mesos with Nvidia GPU support.</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="sandbox.html"><strong aria-hidden="true">32.</strong> Container Sandboxes</a></li><li class="chapter-item expanded "><a href="container-volume.html"><strong aria-hidden="true">33.</strong> Container Volumes</a></li><li class="chapter-item expanded "><a href="nested-container-and-task-group.html"><strong aria-hidden="true">34.</strong> Nested Container and Task Group (Pod)</a></li><li class="chapter-item expanded "><a href="standalone-containers.html"><strong aria-hidden="true">35.</strong> Standalone Containers</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Apache Mesos</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/AVENTER-UG/mesos-docs/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<h2>title: Apache Mesos - Supporting Container Images in Mesos Containerizer
layout: documentation</h2>
<h1 id="supporting-container-images-in-a-hrefmesos-containerizerhtmlmesos-containerizera"><a class="header" href="#supporting-container-images-in-a-hrefmesos-containerizerhtmlmesos-containerizera">Supporting Container Images in <a href="mesos-containerizer.html">Mesos Containerizer</a></a></h1>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>Mesos currently supports several <a href="containerizers.html">containerizers</a>,
notably the Mesos containerizer and the Docker containerizer. Mesos
containerizer uses native OS features directly to provide isolation
between containers, while Docker containerizer delegates container
management to the Docker engine.</p>
<p>Maintaining two containerizers is hard. For instance, when we add new
features to Mesos (e.g., persistent volumes, disk isolation), it
becomes a burden to update both containerizers. Even worse, sometimes
the isolation on some resources (e.g., network handles on an agent)
requires coordination between two containerizers, which is very hard
to implement in practice. In addition, we found that extending and
customizing isolation for containers launched by Docker engine is
difficult, mainly because we do not have a way to inject logics during
the life cycle of a container.</p>
<p>Therefore, we made an effort to unify containerizers in Mesos
(<a href="https://issues.apache.org/jira/browse/MESOS-2840">MESOS-2840</a>,
a.k.a. the Universal Containerizer). We improved Mesos containerizer
so that it now supports launching containers that specify container
images (e.g., Docker/Appc images).</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>To support container images, we introduced a new component in Mesos
containerizer, called image provisioner. Image provisioner is
responsible for pulling, caching and preparing container root
filesystems. It also extracts runtime configurations from container
images which will then be passed to the corresponding isolators for
proper isolation.</p>
<p>There are a few container image specifications, notably
<a href="https://github.com/docker/docker/blob/master/image/spec/v1.md">Docker</a>,
<a href="https://github.com/appc/spec/blob/master/SPEC.md">Appc</a>, and
<a href="https://github.com/opencontainers/specs">OCI</a> (future). Currently, we
support Docker and Appc images. More details about what features are
supported or not can be found in the following sections.</p>
<p><strong>NOTE</strong>: container image is only supported on Linux currently.</p>
<h3 id="configure-the-agent"><a class="header" href="#configure-the-agent">Configure the agent</a></h3>
<p>To enable container image support in Mesos containerizer, the operator
will need to specify the <code>--image_providers</code> agent flag which tells
Mesos containerizer what types of container images are allowed. For
example, setting <code>--image_providers=docker</code> allow containers to use
Docker images. The operators can also specify multiple container image
types. For instance, <code>--image_providers=docker,appc</code> allows both
Docker and Appc container images.</p>
<p>A few isolators need to be turned on in order to provide proper
isolation according to the runtime configurations specified in the
container image. The operator needs to add the following isolators to
the <code>--isolation</code> flag.</p>
<ul>
<li>
<p><code>filesystem/linux</code>: This is needed because supporting container
images involves changing filesystem root, and only <code>filesystem/linux</code>
support that currently. Note that this isolator requires root
permission.</p>
</li>
<li>
<p><code>docker/runtime</code>: This is used to provide support for runtime
configurations specified in Docker images (e.g., Entrypoint/Cmd,
environment variables, etc.). See more details about this isolator in
<a href="mesos-containerizer.html">Mesos containerizer doc</a>. Note that if this
isolator is not specified and <code>--image_providers</code> contains <code>docker</code>,
the agent will refuse to start.</p>
</li>
</ul>
<p>In summary, to enable container image support in Mesos containerizer,
please specify the following agent flags:</p>
<pre><code>$ sudo mesos-agent \
  --containerizers=mesos \
  --image_providers=appc,docker \
  --isolation=filesystem/linux,docker/runtime
</code></pre>
<h3 id="framework-api"><a class="header" href="#framework-api">Framework API</a></h3>
<p>We introduced a new protobuf message <code>Image</code> which allow frameworks to
specify container images for their containers. It has two types right
now: <code>APPC</code> and <code>DOCKER</code>, representing Appc and Docker images
respectively.</p>
<p>For Appc images, the <code>name</code> and <code>labels</code> are what described in the
<a href="https://github.com/appc/spec/blob/master/spec/aci.md#image-manifest-schema">spec</a>.</p>
<p>For Docker images, the <code>name</code> is the Docker image reference in the
following form (the same format expected by <code>docker pull</code>):
<code>[REGISTRY_HOST[:REGISTRY_PORT]/]REPOSITORY[:TAG|@DIGEST]</code></p>
<pre><code>message Image {
  enum Type {
    APPC = 1;
    DOCKER = 2;
  }

  message Appc {
    required string name = 1;
    optional Labels labels = 3;
  }

  message Docker {
    required string name = 1;
  }

  required Type type = 1;

  // Only one of the following image messages should be set to match
  // the type.
  optional Appc appc = 2;
  optional Docker docker = 3;
}
</code></pre>
<p>The framework needs to specify <code>MesosInfo</code> in <code>ContainerInfo</code> in order
to launch containers with container images. In other words, the
framework needs to set the type to <code>ContainerInfo.MESOS</code>, indicating
that it wants to use the Mesos containerizer. If <code>MesosInfo.image</code> is
not specified, the container will use the host filesystem. If
<code>MesosInfo.image</code> is specified, it will be used as the container
image when launching the container.</p>
<pre><code>message ContainerInfo {
  enum Type {
    DOCKER = 1;
    MESOS = 2;
  }

  message MesosInfo {
    optional Image image = 1;
  }

  required Type type = 1;
  optional MesosInfo mesos = 5;
}
</code></pre>
<h3 id="test-it-out"><a class="header" href="#test-it-out">Test it out!</a></h3>
<p>First, start the Mesos master:</p>
<pre><code>$ sudo sbin/mesos-master --work_dir=/tmp/mesos/master
</code></pre>
<p>Then, start the Mesos agent:</p>
<pre><code>$ sudo GLOG_v=1 sbin/mesos-agent \
  --master=&lt;MASTER_IP&gt;:5050 \
  --isolation=docker/runtime,filesystem/linux \
  --work_dir=/tmp/mesos/agent \
  --image_providers=docker \
  --executor_environment_variables=&quot;{}&quot;
</code></pre>
<p>Now, use Mesos CLI (i.e., mesos-execute) to launch a Docker container
(e.g., redis). Note that <code>--shell=false</code> tells Mesos to use the
default entrypoint and cmd specified in the Docker image.</p>
<pre><code>$ sudo bin/mesos-execute \
  --master=&lt;MASTER_IP&gt;:5050 \
  --name=test \
  --docker_image=library/redis \
  --shell=false
</code></pre>
<p>Verify if your container is running by launching a redis client:</p>
<pre><code>$ sudo docker run -ti --net=host redis redis-cli
127.0.0.1:6379&gt; ping
PONG
127.0.0.1:6379&gt;
</code></pre>
<h2 id="docker-support-and-current-limitations"><a class="header" href="#docker-support-and-current-limitations">Docker Support and Current Limitations</a></h2>
<p>Image provisioner uses <a href="https://docs.docker.com/registry/spec/api/">Docker v2 registry
API</a> to fetch Docker
images/layers. Both docker manifest
<a href="https://docs.docker.com/registry/spec/manifest-v2-1/">v2 schema1</a>
and <a href="https://docs.docker.com/registry/spec/manifest-v2-2/">v2 schema2</a>
are supported (v2 schema2 is supported starting from 1.8.0). The
fetching is based on <code>curl</code>, therefore SSL is automatically handled.
For private registries, the operator needs to configure <code>curl</code>
with the location of required CA certificates.</p>
<p>Fetching requiring authentication is supported through the
<code>--docker_config</code> agent flag. Starting from 1.0, operators can use
this agent flag to specify a shared docker config file, which is
used for pulling private repositories with authentication. Per
container credential is not supported yet (coming soon).</p>
<p>Operators can either specify the flag as an absolute path pointing to
the docker config file (need to manually configure
<code>.docker/config.json</code> or <code>.dockercfg</code> on each agent), or specify the
flag as a JSON-formatted string. See <a href="configuration/agent.html">configuration
documentation</a> for detail. For example:</p>
<pre><code>--docker_config=file:///home/vagrant/.docker/config.json
</code></pre>
<p>or as a JSON object,</p>
<pre><code>--docker_config=&quot;{ \
  \&quot;auths\&quot;: { \
    \&quot;https://index.docker.io/v1/\&quot;: { \
      \&quot;auth\&quot;: \&quot;xXxXxXxXxXx=\&quot;, \
      \&quot;email\&quot;: \&quot;username@example.com\&quot; \
    } \
  } \
}&quot;
</code></pre>
<p>Private registry is supported either through the <code>--docker_registry</code>
agent flag, or specifying private registry for each container using
image name <code>&lt;REGISTRY&gt;/&lt;REPOSITORY&gt;</code> (e.g.,
<code>localhost:80/gilbert/inky:latest</code>). If <code>&lt;REGISTRY&gt;</code> is included as
a prefix in the image name, the registry specified through the agent
flag <code>--docker_registry</code> will be ignored.</p>
<p>If the <code>--docker_registry</code> agent flag points to a local directory
(e.g., <code>/tmp/mesos/images/docker</code>), the provisioner will pull Docker
images from local filesystem, assuming Docker archives (result of
<code>docker save</code>) are stored there based on the image name and tag.  For
example, the operator can put a <code>busybox:latest.tar</code> (the result of
<code>docker save -o busybox:latest.tar busybox</code>) under
<code>/tmp/mesos/images/docker</code> and launch the agent by specifying
<code>--docker_registry=/tmp/mesos/images/docker</code>. Then the framework can
launch a Docker container by specifying <code>busybox:latest</code> as the name
of the Docker image. This flag can also point to an HDFS URI
(<em>experimental</em> in Mesos 1.7) (e.g., <code>hdfs://localhost:8020/archives/</code>)
to fetch images from HDFS if the <code>hadoop</code> command is available on the
agent.</p>
<p>If the <code>--switch_user</code> flag is set on the agent and the framework
specifies a user (either <code>CommandInfo.user</code> or <code>FrameworkInfo.user</code>),
we expect that user exists in the container image and its uid and gids
matches that on the host. User namespace is not supported yet. If the
user is not specified, <code>root</code> will be used by default. The operator or
the framework can limit the
<a href="http://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities</a>
of the container by using the
<a href="isolators/linux-capabilities.html">linux/capabilities</a> isolator.</p>
<p>Currently, we support <code>host</code>, <code>bridge</code> and user defined networks
(<a href="https://docs.docker.com/engine/userguide/networking/">reference</a>).
<code>none</code> is not supported yet. We support the above networking modes in
<a href="mesos-containerizer.html">Mesos Containerizer</a> using the
<a href="https://github.com/containernetworking/cni">CNI</a> (Container Network
Interface) standard. Please refer to the <a href="cni.html">network/cni</a>
isolator document for more details about how to configure the network
for the container.</p>
<h3 id="more-agent-flags"><a class="header" href="#more-agent-flags">More agent flags</a></h3>
<p><code>--docker_registry</code>: The default URL for pulling Docker images. It
could either be a Docker registry server URL (i.e:
<code>https://registry.docker.io</code>), or a local path (i.e:
<code>/tmp/docker/images</code>) in which Docker image archives (result of
<code>docker save</code>) are stored. The default value is
<code>https://registry-1.docker.io</code>.</p>
<p><code>--docker_store_dir</code>: Directory the Docker provisioner will store
images in. All the Docker images are cached under this directory. The
default value is <code>/tmp/mesos/store/docker</code>.</p>
<p><code>--docker_config</code>: The default docker config file for agent. Can
be provided either as an absolute path pointing to the agent local
docker config file, or as a JSON-formatted string. The format of
the docker config file should be identical to docker's default one
(e.g., either <code>$HOME/.docker/config.json</code> or <code>$HOME/.dockercfg</code>).</p>
<h2 id="appc-support-and-current-limitations"><a class="header" href="#appc-support-and-current-limitations">Appc Support and Current Limitations</a></h2>
<p>Currently, only the root filesystem specified in the Appc image is
supported. Other runtime configurations like environment variables,
exec, working directory are not supported yet (coming soon).</p>
<p>For image discovery, we current support a simple discovery mechanism.
We allow operators to specify a URI prefix which will be prepend to
the URI template <code>{name}-{version}-{os}-{arch}.{ext}</code>. For example, if
the URI prefix is <code>file:///tmp/appc/</code> and the Appc image name is
<code>example.com/reduce-worker</code> with <code>version:1.0.0</code>, we will fetch the
image at <code>file:///tmp/appc/example.com/reduce-worker-1.0.0.aci</code>.</p>
<h3 id="more-agent-flags-1"><a class="header" href="#more-agent-flags-1">More agent flags</a></h3>
<p><code>appc_simple_discovery_uri_prefix</code>: URI prefix to be used for simple
discovery of appc images, e.g., <code>http://</code>, <code>https://</code>,
<code>hdfs://&lt;hostname&gt;:9000/user/abc/cde</code>. The default value is <code>http://</code>.</p>
<p><code>appc_store_dir</code>: Directory the appc provisioner will store images in.
All the Appc images are cached under this directory. The default value
is <code>/tmp/mesos/store/appc</code>.</p>
<h2 id="provisioner-backends"><a class="header" href="#provisioner-backends">Provisioner Backends</a></h2>
<p>A provisioner backend takes a set of filesystem layers and stacks them
into a root filesystem. Currently, we support the following backends:
<code>copy</code>, <code>bind</code>, <code>overlay</code> and <code>aufs</code>. Mesos will validate if the
selected backend works with the underlying filesystem (the filesystem
used by the image store <code>--docker_store_dir</code> or <code>--appc_store_dir</code>)
using the following logic table:</p>
<pre><code>+---------+--------------+------------------------------------------+
| Backend | Suggested on | Disabled on                              |
+---------+--------------+------------------------------------------+
| aufs    | ext4 xfs     | btrfs aufs eCryptfs                      |
| overlay | ext4 xfs*    | btrfs aufs overlay overlay2 zfs eCryptfs |
| bind    |              | N/A(`--sandbox_directory' must exist)    |
| copy    |              | N/A                                      |
+---------+--------------+------------------------------------------+
</code></pre>
<p>NOTE: <code>xfs</code> support on <code>overlay</code> is enabled only when <code>d_type=true</code>. Use
<code>xfs_info</code> to verify that the <code>xfs</code> ftype option is set to 1. To format
an xfs filesystem for <code>overlay</code>, use the flag <code>-n ftype=1</code> with <code>mkfs.xfs</code>.</p>
<p>The provisioner backend can be specified through the agent flag
<code>--image_provisioner_backend</code>. If not set, Mesos will select the best
backend automatically for the users/operators. The selection logic is
as following:</p>
<pre><code>1. Use `overlay` backend if the overlayfs is available.
2. Use `aufs` backend if the aufs is available and overlayfs is not supported.
3. Use `copy` backend if none of above is selected.
</code></pre>
<h3 id="copy"><a class="header" href="#copy">Copy</a></h3>
<p>The Copy backend simply copies all the layers into a target root
directory to create a root filesystem.</p>
<h3 id="bind"><a class="header" href="#bind">Bind</a></h3>
<p>This is a specialized backend that may be useful for deployments using
large (multi-GB) single-layer images <em>and</em> where more recent kernel
features such as overlayfs are not available. For small images (10's
to 100's of MB) the copy backend may be sufficient. Bind backend is
faster than Copy as it requires nearly zero IO.</p>
<p>The bind backend currently has these two limitations:</p>
<ol>
<li>
<p>The bind backend supports only a single layer. Multi-layer images will
fail to provision and the container will fail to launch!</p>
</li>
<li>
<p>The filesystem is read-only because all containers using this image
share the source. Select writable areas can be achieved by mounting
read-write volumes to places like <code>/tmp</code>, <code>/var/tmp</code>, <code>/home</code>, etc.
using the <code>ContainerInfo</code>. These can be relative to the executor work
directory. Since the filesystem is read-only, <code>--sandbox_directory</code>
and <code>/tmp</code> must already exist within the filesystem because the
filesystem isolator is unable to create it (e.g., either the image
writer needs to create the mount point in the image, or the operator
needs to set agent flag <code>--sandbox_directory</code> properly).</p>
</li>
</ol>
<h3 id="overlay"><a class="header" href="#overlay">Overlay</a></h3>
<p>The reason overlay backend was introduced is because the copy backend
will waste IO and space while the bind backend can only deal with one
layer. The overlay backend allows containizer to utilize the
filesystem to merge multiple filesystems into one efficiently.</p>
<p>The overlay backend depends on support for multiple lower layers,
which requires Linux kernel version 4.0 or later. For more information
of overlayfs, please refer to
<a href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt">here</a>.</p>
<h3 id="aufs"><a class="header" href="#aufs">AUFS</a></h3>
<p>The reason AUFS is introduced is because overlayfs support hasn't been
merged until kernel 3.18 and Docker's default storage backend for
ubuntu 14.04 is AUFS.</p>
<p>Like overlayfs, AUFS is also a unioned file system, which is very
stable, has a lot of real-world deployments, and has strong community
support.</p>
<p>Some Linux distributions do not support AUFS. This is usually because
AUFS is not included in the mainline (upstream) Linux kernel.</p>
<p>For more information of AUFS, please refer to
<a href="http://aufs.sourceforge.net/aufs2/man.html">here</a>.</p>
<h2 id="executor-dependencies-in-a-container-image"><a class="header" href="#executor-dependencies-in-a-container-image">Executor Dependencies in a Container Image</a></h2>
<p>Mesos has this concept of executors. All tasks are launched by an
executor. For a general purpose executor (e.g., thermos) of a
framework (e.g., Aurora), requiring it and all its dependencies to be
present in all possible container images that a user might use is
not trivial.</p>
<p>In order to solve this issue, we propose a solution where we allow the
executor to run on the host filesystem (without a container image).
Instead, it can specify a <code>volume</code> whose source is an <code>Image</code>. Mesos
containerizer will provision the <code>image</code> specified in the <code>volume</code>,
and mount it under the sandbox directory. The executor can perform
<code>pivot_root</code> or <code>chroot</code> itself to enter the container root
filesystem.</p>
<h2 id="garbage-collect-unused-container-images"><a class="header" href="#garbage-collect-unused-container-images">Garbage Collect Unused Container Images</a></h2>
<p>Experimental support of garbage-collecting unused container images was added at
Mesos 1.5. This can be either configured automatically via a new agent flag
<code>--image_gc_config</code>, or manually invoked through agent's
<a href="operator-http-api.html#prune_images">v1 Operator HTTP API</a>. This can be used
to avoid unbounded disk space usage of image stores.</p>
<p>This is implemented with a simple mark-and-sweep logic. When image GC happens,
we check all layers and images referenced by active running containers and avoid
removing them from the image store. As a pre-requisite, if there are active
containers launched before Mesos 1.5.0, we cannot determine what images can be
safely garbage collected, so agent will refuse to invoke image GC. To garbage
collect container images, users are expected to drain all containers launched
before Mesos 1.5.0.</p>
<p><strong>NOTE</strong>: currently, the image GC is only supported for docker store in Mesos
Containerizer.</p>
<h3 id="automatic-image-gc-through-agent-flag"><a class="header" href="#automatic-image-gc-through-agent-flag">Automatic Image GC through Agent Flag</a></h3>
<p>To enable automatic image GC, use the new agent flag <code>--image_gc_config</code>:</p>
<pre><code>--image_gc_config=file:///home/vagrant/image-gc-config.json
</code></pre>
<p>or as a JSON object,</p>
<pre><code>--image_gc_config=&quot;{ \
  \&quot;image_disk_headroom\&quot;: 0.1, \
  \&quot;image_disk_watch_interval\&quot;: { \
    \&quot;nanoseconds\&quot;: 3600000000000 \
    }, \
  \&quot;excluded_images\&quot;: \[ \] \
}&quot;
</code></pre>
<h3 id="manual-image-gc-through-http-api"><a class="header" href="#manual-image-gc-through-http-api">Manual Image GC through HTTP API</a></h3>
<p>See <code>PRUNE_IMAGES</code> section in
<a href="operator-http-api.html#prune_images">v1 Operator HTTP API</a> for manual image GC
through the agent HTTP API.</p>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<p>For more information on the Mesos containerizer filesystem, namespace,
and isolator features, visit <a href="mesos-containerizer.html">Mesos
Containerizer</a>.  For more information on
launching Docker containers through the Docker containerizer, visit
<a href="docker-containerizer.html">Docker Containerizer</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="mesos-containerizer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="isolators/docker-volume.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="mesos-containerizer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="isolators/docker-volume.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
